@model ProjectViewModel

@{
    Layout = null;
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<link rel="stylesheet" href="~/css/UserView.css">

<aside class="sidebar">
    <h2>@Model.Project.ProjectName</h2>
    <ul>
        <li>Dashboard</li>
        <li>Task Board</li>
    </ul>
</aside>
<main class="content">
    <div class="header">
        <div class="create-btn">
            <button onclick="document.getElementById('sprintModal').style.display='block'">Create New Sprint</button>
            <button onclick="document.getElementById('taskModal').style.display='block'">Create New Task</button>
        </div>
        <div>
            <img src="https://i.pravatar.cc/40" alt="User" style="border-radius: 50%">
        </div>
    </div>
    <div class="overview">
        <div class="card">
            <h3>Sprints</h3>
            <p><strong>@Model.Project.Sprints.Count</strong></p>
            <small>0 Completed</small>
        </div>
        <div class="card">
            <h3>Tasks</h3>
            <p><strong>0</strong></p>
            <small>0 Completed</small>
        </div>
        <div class="card">
            <h3>Test</h3>
            <p><strong>Test</strong></p>
            <small>Test</small>
        </div>
    </div>
    <div class="projects-section">
        <h3>Sprints</h3>
        <table>
            <thead>
                <tr>
                    <th>Sprint Name</th>
                    <th>Start Date</th>
                    <th>Finish Date</th>
                    <th>Total Task</th>
                    <th>Progress</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Project.Sprints)
                {
                    <tr>
                        <td>@item.SprintName</td>
                        <td>@item.StartDate.ToString()</td>
                        <td>@item.FinishDate.ToString()</td>
                        <td>@item.Tasks.Count</td>
                        <td><div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="projects-section">
        <h3>Tasks</h3>
        <table>
            <thead>
                <tr>
                    <th>Task Name</th>
                    <th>Task Description</th>
                    <th>Related Sprint</th>
                    <th>Assigned Employee</th>
                    <th>Task Priority</th>
                    <th>Task Status</th>
                </tr>
            </thead>
            <tbody>
                    @foreach (var sprint in Model.Project.Sprints)
                    {
                        @foreach (var item in sprint.Tasks)
                        {
                            <tr>
                                <td>@item.TaskName</td>
                                <td>@item.TaskDesc</td>
                                <td>@sprint.SprintName</td>
                                <td>User Not Assigned</td>
                                <td>
                                    @if (@item.Priority.ToString() == "Low")
                                    {
                                        <span class="badge low">@item.Priority.ToString()</span>
                                    }
                                    else if (@item.Priority.ToString() == "Medium")
                                    {
                                        <span class="badge medium">@item.Priority.ToString()</span>
                                    }
                                    else
                                    {
                                        <span class="badge high">@item.Priority.ToString()</span>
                                    }
                                </td>
                                <td>@item.TaskEffort.ToString()</td>
                            </tr>
                        }
                    }                
            </tbody>
        </table>
    </div>

    <div id="sprintModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('sprintModal')">&times;</span>
            <h2>Create Sprint</h2>
            <form method="post" asp-action="CreateSprint" asp-controller="Project">
                <input type="hidden" asp-for="Project.Id" value="@Model.Project.Id">
                <input type="hidden" asp-for="SprintToCreate.ProjectId" value="@Model.Project.Id">
                <input type="text" asp-for="SprintToCreate.SprintName"  placeholder="Sprint Name" autocomplete="off" required>
                <input type="date" asp-for="SprintToCreate.StartDate"  placeholder="Sprint Start Date">
                <input type="date" asp-for="SprintToCreate.FinishDate"  placeholder="Sprint Finish Date">
                <button type="submit">Create</button>
            </form>
        </div>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('taskModal')">&times;</span>
            <h2>Create Task</h2>
            <form method="post" asp-action="CreateTask" asp-controller="Project">
                <input type="hidden" asp-for="Project.Id" value="@Model.Project.Id">
                <input type="text" asp-for="TaskToCreate.TaskName" placeholder="Task Name">
                <input type="text" asp-for="TaskToCreate.TaskDesc" id="taskDescInput" placeholder="Task Description">

                <select asp-for="TaskToCreate.Priority">
                    <option value="@Priority.Low">Low</option>
                    <option value="@Priority.Medium">Medium</option>
                    <option value="@Priority.High">High</option>
                </select>

                <select asp-for="TaskToCreate.TaskEffort">
                    <option value="@ProjecStatus.New">New</option>
                    <option value="@ProjecStatus.Pending">Pending</option>
                    <option value="@ProjecStatus.Committed">Committed</option>
                    <option value="@ProjecStatus.InProgress">InProgress</option>
                    <option value="@ProjecStatus.Finished">Finished</option>
                </select>

                <select asp-for="TaskToCreate.SprintId" asp-items="@Model.TaskToCreate.SprintList" required>
                    <option value="">Select Dept</option>
                </select>

                <button type="submit">Create</button>
            </form>

            <div id="aiRequestSection" class="mt-3">
                <button class="btn btn-outline-primary" onclick="fetchSubTasks()">AI ile sub task önerileri al</button>
            </div>

            <div id="spinnerSection" class="text-center mt-3 d-none">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Yanıt bekleniyor, lütfen pencereyi kapatmayınız...</p>
            </div>

            <div id="subtaskResults" class="mt-3"></div>

            <div id="aiError" class="alert alert-danger d-none mt-3" role="alert">
                <div class="d-flex align-items-center">
                    <i class="bi bi-x-circle-fill me-2" style="font-size: 1.5rem;"></i>
                    <div>Yapay zeka yanıt oluşturamadı.</div>
                </div>
            </div>
        </div>
    </div>
</main>
<script>
    const sModal = document.getElementById("sprintModal");
    const tModal = document.getElementById("taskModal");
    
    window.onclick = (e) => {
        if (e.target === sModal) sModal.style.display = "none";
        if (e.target === tModal) tModal.style.display = "none";
    };

    function closeModal(id) {
        document.getElementById(id).style.display = "none";
    }

    async function fetchSubTasks() {
        const desc = document.getElementById("taskDescInput").value;
        const btnSection = document.getElementById("aiRequestSection");
        const spinner = document.getElementById("spinnerSection");
        const results = document.getElementById("subtaskResults");
        const error = document.getElementById("aiError");

        results.innerHTML = "";
        error.classList.add("d-none");

        btnSection.classList.add("d-none");
        spinner.classList.remove("d-none");

        try {
            const response = await fetch("/SubTask/CreateByOllama", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ Description: desc })
            });

            const data = await response.json();
            spinner.classList.add("d-none");
            btnSection.classList.remove("d-none");

            if (!Array.isArray(data)) throw new Error("Invalid format");

            results.innerHTML = `<h5>AI Önerileri</h5>`;
            data.forEach(item => {
                results.innerHTML += `
                    <div class="card w-100 mb-3">
                        <div class="card-body">
                            <h6 class="card-title fw-bold">${item.title}</h6>
                            <p class="card-text">${item.description}</p>
                        </div>
                    </div>
                `;
            });
        } catch (err) {
            spinner.classList.add("d-none");
            btnSection.classList.remove("d-none");
            error.classList.remove("d-none");
        }
    }


</script>
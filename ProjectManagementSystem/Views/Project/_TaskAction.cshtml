@model ProjectViewModel
@{
    Layout = null;
}

<div class="task-create-container p-2">
    <!-- Main Form -->
    <form method="post" asp-action="CreateTask" asp-controller="Project" class="task-form">
        <input type="hidden" asp-for="Project.Id" />

        <!-- Title Section -->
        <div class="title-section mb-4 d-flex justify-content-between align-items-center">
            <div class="form-floating flex-grow-1 me-3 position-relative">
                <input asp-for="TaskToCreate.TaskName" class="form-control border-top-0 border-bottom-0 border-start-0 border-end-0 border-bottom border-secondary rounded-0 fs-5 py-3 task-title-input"
                placeholder="Görev başlığı">
                <label asp-for="TaskToCreate.TaskName" class="text-muted">Görev Başlığı</label>
            </div>
            <div class="d-flex gap-2 p-1">
                @if(Model.Project.Id != Guid.Empty)
                {
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i>Sil
                    </button>
                }
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-save me-1"></i>Kaydet
                </button>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="row g-4">
            <!-- Left Column (Main Content) -->
            <div class="col-lg-8">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs" id="taskTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="details-tab" data-bs-toggle="tab"
                                data-bs-target="#details" type="button" role="tab">
                            <i class="bi bi-card-text me-1"></i>Detaylar
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="subtasks-tab" data-bs-toggle="tab"
                                data-bs-target="#subtasks" type="button" role="tab">
                            <i class="bi bi-list-task me-1"></i>Alt Görevler
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content p-3 border-start border-end border-bottom rounded-bottom">
                    <!-- Details Tab -->
                    <div class="tab-pane fade show active" id="details" role="tabpanel">
                        <div class="form-floating mb-3">
                            <textarea asp-for="TaskToCreate.TaskDesc" id="taskDescInput"
                                      class="form-control" placeholder="Açıklama"
                                      style="height: 150px;"></textarea>
                            <label asp-for="TaskToCreate.TaskDesc">Açıklama</label>
                        </div>
                    </div>

                    <!-- Subtasks Tab -->
                    <div class="tab-pane fade" id="subtasks" role="tabpanel">
                        <!-- Manual Subtask Add -->
                        <div class="subtask-add-section mb-4 p-3 bg-light rounded">
                            <h6 class="mb-3 fw-semibold text-primary">
                                <i class="bi bi-plus-circle me-1"></i>Yeni Alt Görev
                            </h6>
                            <div class="row g-2">
                                <div class="col-md-5">
                                    <input type="text" class="form-control form-control-sm"
                                           id="subtaskTitleInput" placeholder="Başlık">
                                </div>
                                <div class="col-md-5">
                                    <input type="text" class="form-control form-control-sm"
                                           id="subtaskDescInput" placeholder="Açıklama">
                                </div>
                                <div class="col-md-2 align-content-center">
                                    <button type="button" class="btn btn-sm btn-primary w-100"
                                            onclick="addManualSubtask()">
                                        Ekle
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Subtask List -->
                        <div id="finalSubtaskList" class="mb-3"></div>

                        <!-- AI Section -->
                        <div class="ai-section mt-4">
                            <button type="button" id="aiSuggestedSubTaskBtn"
                                    class="btn btn-primary btn-sm"
                                    onclick="getAiSuggestedSubTasks()">
                                <i class="bi bi-stars me-1"></i>AI ile Alt Görev Öner
                            </button>

                            <div id="spinnerSection" class="d-none mt-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Yükleniyor...</span>
                                </div>
                                <p class="text-muted mt-2">AI önerileri alınıyor...</p>
                            </div>

                            <div id="subtaskResults" class="mt-3"></div>

                            <div id="aiError" class="alert alert-danger d-none mt-3" role="alert">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                Yapay zeka yanıt oluşturamadı
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column (Properties) -->
            <div class="col-lg-4">
                <div class="task-properties p-1 w-auto card shadow-sm">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 fw-semibold">
                            <i class="bi bi-gear me-1"></i>Özellikler
                        </h6>
                    </div>
                    <div class="card-body">
                        <!-- Status -->
                        <div class="mb-3">
                            <label asp-for="TaskToCreate.TaskEffort" class="form-label small fw-semibold">
                                Durum
                            </label>
                            <select asp-for="TaskToCreate.TaskEffort"
                                    class="form-select form-select-sm">
                                <option value="@ProjecStatus.New">Yeni</option>
                                <option value="@ProjecStatus.InProgress">Devam Ediyor</option>
                                <option value="@ProjecStatus.Done">Tamamlandı</option>
                            </select>
                        </div>

                        <!-- Priority -->
                        <div class="mb-3">
                            <label asp-for="TaskToCreate.Priority" class="form-label small fw-semibold">
                                Öncelik
                            </label>
                            <select asp-for="TaskToCreate.Priority"
                                    class="form-select form-select-sm">
                                <option value="@Priority.Low">Düşük</option>
                                <option value="@Priority.Medium">Orta</option>
                                <option value="@Priority.High">Yüksek</option>
                            </select>
                        </div>

                        <!-- Sprint -->
                        <div class="mb-3">
                            <label asp-for="TaskToCreate.SprintId" class="form-label small fw-semibold">
                                Sprint
                            </label>
                            <select asp-for="TaskToCreate.SprintId"
                                    asp-items="@Model.TaskToCreate.SprintList"
                                    class="form-select form-select-sm" required>
                                <option value="">Seçiniz</option>
                            </select>
                        </div>

                        <!-- Assignee -->
                        <div class="mb-3">
                            <label asp-for="TaskToCreate.UserId" class="form-label small fw-semibold">
                                Atanan
                            </label>
                            <select asp-for="TaskToCreate.UserId"
                                    asp-items="@Model.TaskToCreate.UserList"
                                    class="form-select form-select-sm" required>
                                <option value="">Seçiniz</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Hidden inputs for subtasks -->
                <div id="hiddenSubtaskInputs"></div>
            </div>
        </div>
    </form>
</div>

<script>
    $(document).ready(function(){
        finalSubtasks.length = 0;
    });
</script>